<script>
    //This function gets called when the Save button is pushed
    var batchnum = 0;
    var freeformType = "{{ q.getFreeformItem.freeformType }}";
    saveFunctions.push(function () {
        //The id of the round is saved in a variable called roundPk

        d = new Date();
        var batchid = d.getTime()+ "" + batchnum;
        batchnum++;
        $("#{{ q.id }}").find('.answer').each(function (i, elem) {
            var json = {
                'questionPk': {{ q.id }},
                'roundPk': roundPk,
                'label': $(elem).closest('label').data('id'),
                'subjectUser': $(elem).closest('label').data('id'),
                'batchid': batchid
            };

            // ToDo: Make this work for Rest and All as well
            {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %} 
                json.answer = tinyMCE.get(elem.id).getContent();
            {% else %}
                json.answer = elem.value;
            {% endif %}

            sendToView(json);
        });
    });

    getResponses({{ q.id }}, function (responses) {
        console.log('Responses for {{ number|add:"1" }}:');
        console.log(responses);
        console.log(responses.answers.length);
        //Todo: Fix this so that 'none' grouping works as well
        //Todo: Make users save properly
        for (var x = 0; x < responses.answers.length; x++)
            {% if q.questionGrouping.grouping == "None" %}
                {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %}
                    json.answer = tinyMCE.get('tinymce{{ number }}').setContent(answers[0]);
                {% else %}
               $("#{{ q.id }}").find(".answer")[0].value = responses.answers[0];
                {% endif %}
            {% else %}
                {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %}
                    for (var x = 0; x < responses.answers.length; x++) {
                        console.log('tinymce-{{number}}-'+responses.labelOrUserIds[x]);
                        tinyMCE.get('tinymce-{{number}}-'+responses.labelOrUserIds[x]).setContent(responses.answers[x]);
                    }
                {% else %}
                    $("#{{ q.id }}").find('label').each(function (i, elem) {
                        if (Number(elem.dataset.id) == Number(responses.labelOrUserIds[x])) {
                            $(elem).find('.answer')[0].value = responses.answers[x];
                        }
                    });
                {% endif %}
            {% endif %}
    });

</script>
<p><strong>{{ number|add:"1" }}</strong>. {{ q.questionText }}</p>
{% if q.questionGrouping.grouping == "None" %}
    {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %}
        <textarea class="form-control tinymce" id = 'tinymce{{number}}' rows="5" class="answer"></textarea>
    {% elif q.get_freeform_item.freeformType == q.get_freeform_item.WORD %}
        <input type="text" maxlength="25" class="answer"></input>
    {% elif q.get_freeform_item.freeformType == q.get_freeform_item.INTEGER %}
        <input type="number" step='1' class="answer"></input>
    {% elif q.get_freeform_item.freeformType == q.get_freeform_item.REAL %}
        <input type="number" class="answer"></input>
    {% endif %}
{% elif q.questionGrouping.grouping == "Label" %}
    {% for l in q.get_labels %}
        <span>{{ l.labelText }}:</span>
        <p>
            <label data-id="{{ l.id }}">
                {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %}
                    <textarea class="answer tinymce" id = "tinymce-{{number}}-{{l.id}}"></textarea>
                {% elif q.get_freeform_item.freeformType == q.get_freeform_item.WORD %}
                    <input type="text" maxlength="25" class="answer"></input>
                {% elif q.get_freeform_item.freeformType == q.get_freeform_item.INTEGER %}
                    <input type="number" step='1' class="answer"></input>
                {% elif q.get_freeform_item.freeformType == q.get_freeform_item.REAL %}
                    <input type="number" class="answer"></input>
                {% endif %}
            </label>
        </p>
    {% endfor %}
{% elif q.questionGrouping.grouping == "All" %}
    {% for u in teamMembers %}
        <span>{{ u.user.name }} {{ u.user.surname }}:</span>
        <p>
            <label data-id="{{ u.user.id }}">
                {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %}
                    <textarea class="form-control tinymce" id = "tinymce-{{number}}-{{u.user.id}}" class="answer"></textarea>
                {% elif q.get_freeform_item.freeformType == q.get_freeform_item.WORD %}
                    <input type="text" maxlength="25" class="answer"></input>
                {% elif q.get_freeform_item.freeformType == q.get_freeform_item.INTEGER %}
                    <input type="number" step='1' class="answer"></input>
                {% elif q.get_freeform_item.freeformType == q.get_freeform_item.REAL %}
                    <input type="number" class="answer"></input>
                {% endif %}
                </label>
        </p>
    {% endfor %}
{% elif q.questionGrouping.grouping == "Rest" %}
    {% for u in teamMembers %}
        {% if u.user != currentUser %}
            <p>
                <label data-id="{{ u.user.id }}"><span
                        style="width:100%; float:left">{{ u.user.name }} {{ u.user.surname }}:</span>
                    {% if q.get_freeform_item.freeformType == q.get_freeform_item.PARAGRAPH %}
                        <textarea class="form-control tinymce" class="answer" id = "tinymce-{{number}}-{{u.user.id}}"></textarea>
                    {% elif q.get_freeform_item.freeformType == q.get_freeform_item.WORD %}
                        <input type="text" maxlength="25" class="answer"></input>
                    {% elif q.get_freeform_item.freeformType == q.get_freeform_item.INTEGER %}
                        <input type="number" step='1' class="answer"></input>
                    {% elif q.get_freeform_item.freeformType == q.get_freeform_item.REAL %}
                        <input type="number" class="answer"></input>
                    {% endif %}
                    </label>
            </p>
        {% endif %}
    {% endfor %}
{% endif %}
<br/>