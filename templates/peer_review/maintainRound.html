{% extends "peer_review/baseAdmin.html" %}
{% load staticfiles %}

{% block extrahead %}
    <title>Rounds</title>
   <!-- <script src="{% static "peer_review/search.js" %}"></script>-->
    <script src="{% static "peer_review/validation.js" %}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            
           // addOnSubmitHandler();
            $('#round').DataTable();

            $('#search').keyup(function () {
                t = $('#round').DataTable();
                t.search($('#search').val()).draw();
            })

          
        });
    </script>
    <!--Edit navbar active-->
    <script>
        title = "maintainRound";
    </script>

<script type="text/javascript">
    function textBox(text) {
            return '<td style="text-align: center; ">' +
                    '<input type="text" class="noBorder" id="choice" value="' +
                    text +
                    '" style="text-align: center; "/>' +
                    '</td>';
        }
     function addRow(text, selector) {

            $table = $(selector);
            $('#round tr:last').after('<tr>' + '<td style="text-align: center; width: 10px;">' +
                '<input type="number" class="noBorder" style="text-align: center; "/>' +
                '</td>'+'</tr>');
        
        }
    </script>

<script type="text/javascript">
    
       // }

function addOnSubmitHandler() {
            $('#roundForm').on('submit', function (event) {
                event.preventDefault();
            });
            /*$('#round').on('submit', function (event) {
                event.preventDefault();
            });*/
        }

        function minusOnSubmitHandler(){
            $('#round').on('submit', function (event) {
                event.preventDefault();
            });
        }
    function editRound(pk)
        {
            isEditing = true;
            roundPk = pk;

            $.ajax({
                url: '/maintainRound/getRound/' + pk,
                type: 'get',
                success: function(data) {
                    console.log(data);
                    $('#desc').val(data.description);
                    $('#quest').val(data.questionnaire);
                    $('#startdate').val(data.startingDate);
                    $('#endingDate').val(data.endingDate);
                    selected();
                },
                failure: function(data) { 
                    alert('Error');
                }
            });//End ajax
            
        }

function createJson() {
            alert("Create Json")
        

            var data = {
                description: $('#roundDescription').val(),
                name: $('#roundName').val(),
                questionnaire: $('#questionnaire').val(),
                startingDate: $('#startingDate').val(),
                endingDate: $('#endingDate').val(),
            };

            console.log(data);
            return data;
        }
// AJAX for posting
        function create_post() {  


         alert('create_post')
            //Validation
            var cname = $('#name').val()
            var cdesc = $('#description').val()
            var cquest = $('#questionnaire').val()
            var cstart = $('#startingDate').val()
            var cend = $('#endingDate').val()
            var test =false


            if (cname == '') {
                $('#round-label-error').html('<div class="alert alert-danger">This is a required field</div>')
                test = true
            }
            else{
                $('#round-label-error').html('')
                test = false

            }
            if (cdesc == '') {
                $('#round-label2-error').html('<div class="alert alert-danger">This is a required field</div>')
                test = true

            }
            else{
                $('#round-label2-error').html('')
                test = false

            }

            

            if (cquest == '') {
                $('#round-label3-error').html('<div class="alert alert-danger">This is a required field</div>')
                test = true
            }
            else{
                $('#round-label3-error').html('')
                test = false

            }
            

            if (cstart == '') {
                $('#round-label4-error').html('<div class="alert alert-danger">This is a required field</div>')
                test = true
            }
            else{
                $('#round-label4-error').html('')
                test = false
            }
            

            if (cend == '') {
                $('#round-label5-error').html('<div class="alert alert-danger">This is a required field</div>')
                test = true
            }
            else{
                $('#round-label5-error').html('')
                test = false

            }
            //alert(test)


            if(test==true){

                addOnSubmitHandler()
                return
            }

            //alert('Past')
            minusOnSubmitHandler()
            var data = createJson();
            $.ajax({
                url: "/createRound/", // the endpoint
                type: "GET", // http method
                data: data, // data sent with the post request
                success: function () {console.log('Round was saved successfully.')},
                failure: function () {alert('Error occurred in saving the question');}
                });

        
            
        };
        function CreateQuestionnaire(text){

                //alert(text)

                if (text == "create"){
                   // alert(text)
                    window.location.href='/questionnaireAdmin'
                }


        };
       function validate_date(d){


            alert(d)
            var cstart = $('#startingDate').val()
            alert(cstart)
            try{
                datetime.strptime(d, '%Y/%m/%d %H:%i')
                return True
            }
            catch( ValueError)
            {
                alert("incorrect")
                return False
            }

        };

        function test(){
            alert('meow')
        }




</script>


    <script>
        title = "maintainRound";
    </script>

{% endblock extrahead %}
{% block context %}

<!--Function to add row-->


<!--end-->
 <div class="container">
        <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapseOne">
                    <h4 class="panel-title">
                        <a>
                            Create Round<b class="caret"> </b>
                        </a>
                    </h4>
                </div>

                <div id="collapseOne" class="panel-collapse collapse in">
                    <div class="panel-body">


             <form role="form" id="roundForm" action="/createRound/" method="GET">

                    {% csrf_token %}
                    <input type="hidden" id="tableData">


                    <div class="form-group">
                        <label for="name">Name</label>

                        <textarea class="form-control" rows="1" style="resize:none;width:20%" id="name"

                                  name="name"></textarea>
                        <div id = "round-label-error">
                        </div>
                        <br/>


                    <div class="form-group">
                        <label for="description">Description</label>

                        <textarea class="form-control" rows="2" style="resize:none;width:45%" id="description"

                                  name="description"></textarea>
                        <div id = "round-label2-error">
                        </div>
                        <br/>

                        <div>
                        <label for="questionnaire">Questionnaire</label>
                        </div>
                        <div class="col-xs-5">
                                <select id="questionnaire" name="questionnaire" class="form-control" 
                                style="width:auto" >

                                <option selected value="{{round.questionnaire.pk}}">{{ round.questionnaire.intro}}</option>
                            {% for quest in questionnaires %}
                                    {% if round.questionnaire.intro = quest.intro %}

                                            {% else %}
                                                <option value="{{quest.pk}}">{{ quest.intro }}</option>     
                                    {% endif %}
                                            

                                        
                            {% endfor %}
                                       </select> 
                                       <div id = "round-label3-error">

                           <br/>
                           </div>
                           <label for="startingDate">Starting Date</label>
                           <div>

                            <input type="datetime-local"  name="startingDate" value=""  id ="startingDate"></input>
                                <div id = "round-label4-error"> </div>

                            </div>

                           <br/>
                           <label for="endingDate">Ending Date</label>
                           <div>

                            <input type="datetime-local"  name="endingDate" value=""  id ="endingDate"></input>
                                <div id = "round-label5-error"></div>

                            </div>


                            <br/>
                           <div class = "row">
                            <div class = "col-xs-11">
                                <button class="btn btn-primary" onclick="create_post()">Save</button>
                            </div>
                           
                        </div>
                    </div>
                </div>
            </div>
</form>
        </div>
    </div>
    </div>
    
<div class="panel panel-default">
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapseTwo">
                    <h4 class="panel-title">
                        <a>
                            Maintain Round <b class="caret"></b>
                        </a>
                    </h4>
                </div>
	            <div id="collapseTwo" class="panel-collapse collapse">
                    <div class="panel-body">

                    
                    <div class='table-responsive'>

                        <table  id='round'>
                            <thead>
                                <tr>
                                    <th>Round Name</th>
                                    <th>Round Description</th>
                                    <th>Questionnaire Description</th>
                                    <th>Starting Date</th>
                                    <th>Ending Date</th>
                            <!--        <th>Maintain</th>-->
                                    <th>Accept Edit</th>
                                    <th>Remove</th>
                                    <th>Dump</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for round in roundDetail %}
                                <tr id="{{ round.pk }}">
                                    <form action = "/maintainRound/update/{{round.pk}}" method = "POST">
                                                {% csrf_token %}

<!--ROUND DESCRIPTION-->
                                         <td><input type="text" style="width: 100px" class="noBorder"
                                                 name="name"
                                                value="{{ round.name }}">
                                            </input ></td>

                                        <td><input type="text" style="width: 150px" class="noBorder"
                                                 name="desc"
                                                value="{{ round.description }}">
                                            </input ></td>
                                      

<!--SELECT FOR QUESTIONNARE-->
                                        <td>
                                       <select id="questionn" name="questionn" class="form-control" 
                                style="width:auto" onchange="CreateQuestionnaire(value)">

                                <option selected value="{{round.questionnaire.pk}}">{{ round.questionnaire.intro}}</option>
                            {% for quest in questionnaires %}
                                    {% if round.questionnaire.intro = quest.intro %}

                                            {% else %}
                                                <option value="{{quest.pk}}">{{ quest.intro }}</option>     
                                    {% endif %}
                                            

                                        
                            {% endfor %}
                                         <option value="create">Create Questionnaire</option> 
                                       </select> 

<!--STARTING DATE-->



                                               <td><input type="datetime" style="width: 200px" class="noBorder" name="startingDate"

                                                       value="{{round.startingDate|date:'DATETIME_FORMAT'}}" ></input>
                                                </td>



<!--ENDINGDATE-->
                                                <td>
                                                    <input type="datetime" style="width: 200px" class="noBorder"
                                                           name="endingDate"

                                                           value="{{ round.endingDate|date:'DATETIME_FORMAT' }}"></input></td>


<!--SPANNER-->
        <!--                                        <td><button type='button' class='btn btn-default btn-xs' id='maintain'  onclick="window.location.href='/maintainTeam'"><span class="glyphicon glyphicon-wrench"></span></button></button></a></button></td>-->

<!--EDIT-->
                
 <td>
                                                <button type='submit' name="edit" class='btn btn-success btn-xs'
                                                        id='edit' value="{{ round.description }}" onclick="validate_date(round.startingDate)" >Edit
                                                </button>
                                            </td>
                                             </form>

<!--DELETE-->
                                            <td>
                                                    {% csrf_token %}
                                                    <button type='submit' name="delete" class='btn btn-warning btn-xs'
                                                            id='remove'>Delete
                                                    </button>
                                            </td>

                                            <td>
                                                <input type="button" class="btn btn-info btn-xs dump" value="Data Dump" data-pk="{{ round.pk }}">
                                            </td>

                                        </tr>
                                    {% endfor %}
                                   
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script>
            $(".dump").on("click", function() {
                var pk = $(this).data("pk");

                var data = {
                    "roundPk": pk,
                    "csrfmiddlewaretoken": "{{ csrf_token }}"
                };

                $.ajax({
                    type: "POST",
                    url: "/maintainRound/dump/",
                    data: data,
                    success: function(data) {
                        alert("Success");
                    }
                });
            });
        </script>
{% endblock context %}