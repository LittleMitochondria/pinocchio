

{% extends "peer_review/base.html" %}
{% load staticfiles %}

{% block extrahead %}
    <title>Create Question</title>

    <script type="text/javascript" src="{% static "peer_review/js/stacking.js" %}"></script>
    <script type="text/javascript">
        /**Todo**
        Implement saving label type and freeform type
        Fix saving of rank type
        Delete using Ajax
        Add an 'editSuccess' function (Or use the old one, with a parameter?)
        Update the question list using Ajax, after insertion or deletion
        Fix the label table
        Save the labels to the DB when label grouping is selected
        Stop the random empty table row being saved sometimes
        Refactor: Clean up the create_post ajax call
        Refactor: Move js code to a seperate file
        */


        var isEditing = false;
        var questionPk;
        $(document).ready(function () {
            addOnSubmitHandler();
            selected();
        });

        function addOnSubmitHandler() {
            $('#questionForm').on('submit', function (event) {
                event.preventDefault();
                //create_post();
            });
        }

        function saveSuccess() {
            //Show success alertbox thingy
            $('#results').html('<div class="alert alert-success">Success! Question saved to database.</div>');

            //Make the alert box disappear after 5 seconds
            window.setTimeout(function () {
                $(".alert").fadeTo(500, 0).slideUp(500, function () {
                    $(this).remove();
                });
            }, 5000);

            //This clear the box even when editing, for some reason
            //Clear question inputbox
            //$('#question').val([]);
        }

        function changeGrouping() {
            //Shows the label table if the grouping is changed to 'label'
            if ($('#grouping').val() === 'Label') {
                $('#labelTable').parent().parent().fadeIn();
                $('.labelTable').fadeIn();
            } else {
                $('#labelTable').parent().parent().fadeOut();
                $('.labelTable').fadeOut();
            }

        }

        function selected() {
            var value = document.getElementById("type").value;
            document.getElementById("typeDisplay").innerHTML = document.getElementById(value).innerHTML;
            initialiseStacking();
            changeGrouping();

            if ($('#type').val() == 'Label')
                $('.hide_in_label').hide();
            else
                $('.hide_in_label').show();

            if ($('#type').val() == 'Rank')
                $('#add').hide();
            else
                $('#add').show();

        }

        function getAllRows() {
            var myObjects = [];

            $('#typeDisplay table tbody tr').each(function (index, value) {
                var row = getRow(index);
                myObjects.push(row);
            });

            return myObjects;
        }

        function getChoices() {
            var choices = [];

            $('#typeDisplay table tbody tr').each(function (index, value) {
                var choice = $('#typeDisplay table tbody tr').eq(index).find('td:eq(0)').find('*').val();
                if (choice != '')
                    choices.push(choice);
            });

            return choices;
        }

        function getRates() {
            var rates = [];

            $('#typeDisplay table tbody tr').each(function (index, value) {
                var $tr = $('#typeDisplay table tbody tr');
                var scale = $tr.eq(index).find('td:eq(0)').find('*').is(':checked');
                var optional = $tr.eq(index).find('td:eq(1)').find('*').is(':checked');
                var choice = $tr.eq(index).find('td:eq(2)').find('*').val();

                if (choice != '') {
                    rates.push({scale: scale, optional: optional, choice: choice});
                }
            });

            return rates;
        }

        // Read the row into an object
        function getRow(rowNum) {
            var row = $('#typeDisplay table tbody tr').eq(rowNum);

            var myObject = {};

            myObject.ChangeType = row.find('td:eq(0)').text();
            myObject.UpdateType = row.find('td:eq(1)').text();
            myObject.three = row.find('td:eq(2)').text();

            return myObject;
        }

        var upArrow = '<td style="text-align: center; width: 20px;">' +
                '<a class="move up" href="javascript:void(0)" title="move up">' +
                '<span class="glyphicon glyphicon-arrow-up"></span>' +
                '</a>' +
                '</td>';

        var downArrow = '<td style="text-align: center; width: 20px; ">' +
                '<a class="move down" href="javascript:void(0)" title="move down">' +
                '<span class="glyphicon glyphicon-arrow-down"></span>' +
                '</a>' +
                '</td>';

        var numberBox = '<td style="text-align: center; width: 10px;">' +
                '<input type="number" class="noBorder" style="text-align: center; "/>' +
                '</td>';

        var checkBox = '<td style="text-align: center; width: 10px;">' +
                '<div class="checkbox">' +
                '<input type="checkbox">' +
                '</div>' +
                '</td>';

        var removeButton = '<td style="text-align: center; width: 20px; ">' +
                '<a class="remove" href="javascript:void(0)">' +
                '<span class="glyphicon glyphicon-minus"></span>' +
                '</a>' +
                '</td>';

        var dropDown = '<td>' +
                '<select class="form-control" id = "type">' +
                '<option value="Word">Word</option>' +
                '<option value="Paragraph">Paragraph</option>' +
                '<option value="Integer">Integer</option>' +
                '<option value="Real">Real</option>' +
                '</select>' +
                '</td>';

        function editQuestion(pk)
        {
            isEditing = true;
            questionPk = pk;

            $.ajax({
                url: '/questionAdmin/getQuestion/' + pk,
                type: 'get',
                success: function(data) {
                    console.log(data);
                    $('#question').val(data.questionText);
                    $('#type').val(data.questionType);
                    $('#grouping').val(data.questionGrouping);
                    selected();
                },
                failure: function(data) { 
                    alert('Error');
                }
            });//End ajax

            if ($('#type').val() == "Choice")
            {
                $.ajax({
                url: '/questionAdmin/getChoices/' + pk,
                    type: 'get',
                    success: function(data) {
                        console.log(data);
                        for (var c in data)
                            if (data.hasOwnProperty(c))
                            {
                                addRow(data[c], '#table');
                            }
                    },
                });//End ajax
            }
        }

        function textBox(text) {
            return '<td style="text-align: center; ">' +
                    '<input type="text" class="noBorder" id="choice" value="' +
                    text +
                    '" style="text-align: center; "/>' +
                    '</td>';
        }

        function addRow(text, selector) {
            $table = $(selector);
            if (selector != '#labelTable') {
                switch ($('#type').val()) {
                    case 'Choice':
                        $table.append('<tr>' + textBox(text) + upArrow + downArrow + removeButton + '</tr>');
                        break;
                    case 'Rate':
                        $table.append('<tr>' + checkBox + numberBox + textBox(text) + upArrow + downArrow + removeButton + '</tr>');
                        break;
                    case 'Freeform':
                        $table.append('<tr>' + dropDown + textBox(text) + upArrow + downArrow + removeButton + '</tr>');
                        break;
                    default:
                        break;
                }
            } else {
                $table.append('<tr>' + textBox(text) + upArrow + downArrow + removeButton + '</tr>');
            }
        }

        function createJson() {
            var data = {
                    question: $('#question').val(),
                    questionType: $('#type').val()
            };

            switch ($('#type').val()) {
                case 'Choice':
                    data.choices = getChoices()
                    data.grouping = $('#grouping').val();
                    break;
                case 'Rank':
                    data.firstWord = $('#first').val();
                    data.secondWord = $('#second').val();
                    data.grouping = $('#grouping').val();
                    break;
                case 'Label':
                    //Todo: Implement
                    break;
                case 'Rate':
                    data.rates = getRates();
                    data.grouping = $('#grouping').val();
                    break;
                case 'Freeform' :
                    //Todo: Implement
                    break;
            }

            return data;
        }

        // AJAX for posting
        function create_post() {

            if (isEditing) {
                var data = createJson();
                data.pk = questionPk;
                $.ajax({
                    url: "questionAdmin/update", // the endpoint
                    type: "GET", // http method
                    data: data, // data sent with the post request

                    // handle a successful response
                    success: saveSuccess()
                });

            } else {

            
                if ($('#question').val() == '') {
                    var r = confirm("No question entered. Save anyways?");
                    if (!r)
                        return;
                }

                var data = createJson();

                console.log(data); //Check

                //Send the data to the createQuestion view
                $.ajax({
                    url: "/createQuestion/", // the endpoint
                    type: "GET", // http method
                    data: data, // data sent with the post request

                    // handle a successful response
                    success: saveSuccess()
                });
            }
        };
    </script>
    <script src="{% static "peer_review/search.js" %}"></script>
    <script src="{% static "peer_review/validation.js" %}"></script>
    <!--<script src="{% static "peer_review/submit.js" %}"></script>-->
    <script type="text/javascript">
        $(document).ready(function () {
            $('#users tr').each(function () {
                $(this).find('input[type="text"]').each(function () {
                    $(this).attr('size', $(this).val().length);
                });
            });
        });
    </script>
    <!--Edit navbar active-->
    <script>
        title = "questionAdmin";
    </script>
    <!--end-->
{% endblock %}

{% block context %}
    <div class="container" id="content">
        <div class="panel panel-default">
            <div id="results">
            </div>
            <div class="panel-heading">
                <h4 class="panel-title">
                    <b>Create Question</b>
                </h4>
            </div>
            <div class="panel-body">
                <form role="form" id="questionForm" action="/createQuestion/" method="GET">
                    {% csrf_token %}
                    <input type="hidden" id="tableData">

                    <div class="form-group">
                        <label for="question">Question</label>
                        <textarea class="form-control" cols="152" rows="3" style="resize:none;width:auto" id="question"
                                  name="question">{{ questionText }}</textarea>
                        <br/>

                        <div class="row">
                            <div class="col-xs-5">
                                <label>Type</label>
                            </div>
                            <div class="col-xs-5">
                                <label class="hide_in_label">Grouping</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-5">
                                <select id="type" class="form-control" style="width:auto" onchange="selected()"
                                        name="type" value = {{ questionType }}>
                                    {% if questionTypes %}
                                        {% for qt in questionTypes %}
                                            {% if qt = questionType %}
                                                <option selected value="{{qt.name}}">{{ qt.name }}</option>
                                            {% else %}
                                                <option value="{{qt.name}}">{{ qt.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-xs-5">
                                <select class="form-control hide_in_label" id="grouping" style="width:auto"
                                        onchange="changeGrouping()">
                                    <option value="None">None</option>
                                    <option value="Rest">Rest</option>
                                    <option value="All">All</option>
                                    <option value="Label">Label</option>
                                </select>
                            </div>
                        </div>
                        <br/>

                        <div id="typeDisplay">
                            <div class="row">
                                <div class="col-xs-5">
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <table id="table" class="table"></table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <br/>
                            <button class="btn btn-primary" type="submit" onclick = "create_post()">Save</button>
                        </div>
                    </div>
                    </form>
            </div>
        </div>
    </div>
    <div id="hidden" class="hidden">
        <div id="Label"></div>
        <div id="Choice">
            <div class="row hide_in_label">
                <div class="col-xs-1">
                    <button class="btn btn-primary" id="btn" type="button" onclick="addRow('', '#table')">+ Add</button>
                </div>
                <div class="col-xs-8">
                </div>
                <div class="col-xs-1">
                    <button class="btn btn-primary labelTable" id="btn" type="button"
                            onclick="addRow('', '#labelTable')">+ Add
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="table" class="table table-striped table-condensed table-hover btable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Choices</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                                {% for c in choices %}
                                    <tr>
                                        <td style="text-align: center; ">
                                            <input type="text" class="noBorder" id="choice" value= "{{ c }}" style="text-align: center; "/>
                                        </td>
                                        <td style="text-align: center; width: 20px;">
                                            <a class="move up" href="javascript:void(0)" title="move up">
                                                <span class="glyphicon glyphicon-arrow-up"></span>
                                            </a>
                                        </td>

                                        <td style="text-align: center; width: 20px; ">
                                            <a class="move down" href="javascript:void(0)" title="move down">
                                                <span class="glyphicon glyphicon-arrow-down"></span>
                                            </a>
                                        </td>

                                        <td style="text-align: center; width: 20px; ">
                                            <a class="remove" href="javascript:void(0)">
                                                <span class="glyphicon glyphicon-minus"></span>
                                            </a>
                                        </td>
                                    <tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="labelTable"
                                   class="table table-striped table-condensed table-hover btable labelTable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Label</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="Rate">
            <div class="row hide_in_label">
                <div class="col-xs-1">
                    <button class="btn btn-primary" id="btn" type="button" onclick="addRow('', '#table')">+ Add</button>
                </div>
                <div class="col-xs-10">
                </div>
                <div class="col-xs-1">
                    <button class="btn btn-primary labelTable" id="btn" type="button"
                            onclick="addRow('', '#labelTable')">+ Add
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-7">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="table" class="table table-striped table-condensed table-hover btable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Optional</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Scale</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Choice</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="labelTable"
                                   class="table table-striped table-condensed table-hover btable labelTable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Label</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="Rank">
            <div class="row">
                <div class="col-xs-4">
                    <label for='first'>First Word</label>
                </div>
                <div class="col-xs-4">
                    <label for='second'>Second Word</label>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-4">
                    <input class='form-control' type='text' id='first'/ value = {{ firstWord }}>
                </div>
                <div class="col-xs-4">
                    <input class='form-control' type='text' id='second'/>
                </div>
                <div class="col-xs-4">
                </div>
            </div>
            <br>

            <div class="row hide_in_label">
                <div class="col-xs-1">
                    <button class="btn btn-primary labelTable" id="btn" type="button"
                            onclick="addRow('', '#labelTable')">+ Add
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="labelTable"
                                   class="table table-striped table-condensed table-hover btable labelTable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Label</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="Freeform">
            <div class="row hide_in_label">
                <div class="col-xs-1">
                    <button class="btn btn-primary" id="btn" type="button" onclick="addRow('', '#table')">+ Add</button>
                </div>
                <div class="col-xs-8">
                </div>
                <div class="col-xs-1">
                    <button class="btn btn-primary labelTable" id="btn" type="button"
                            onclick="addRow('', '#labelTable')">+ Add
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="table" class="table table-striped table-condensed table-hover btable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Type</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Value</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                    <th style="text-align: center; width: 20px; ">
                                        <div class="th-inner "></div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="labelTable"
                                   class="table table-striped table-condensed table-hover btable labelTable">
                                <thead>
                                <tr>
                                    <th style="text-align: center; ">
                                        <div class="th-inner ">Label</div>
                                        <div class="fht-cell"></div>
                                        <div style="margin: 0px 2px 2px; display: none;" class="filterControl">
                                            <div style="height: 34px;"></div>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel panel-default">
                    <div class="panel-heading" data-toggle="collapse" data-parent="#accordion"
                         data-target="#collapseOne">
                        <h4 class="panel-title">
                            <a>
                                Maintain Questions <b class="caret"></b>
                            </a>
                        </h4>
                    </div>

                    <div id="collapseOne" class="panel-collapse collapse">
                        <div class="panel-body">

                            <input type="text" class="form-control" id="search" placeholder="Search"
                                   onkeyup="showResult(this.value)">

                            <div class='table-responsive'>
                                <table class='table sortable' id='users'>
                                    <thead>
                                    <tr>
                                        <th>Question</th>
                                        <th>Publish Date</th>
                                        <th>Question Type</th>
                                        <th>Grouping</th>
                                        <!--<th>Edit</th>-->
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for question in questions %}
                                        <tr id="{{ question.pk }}">
                                            <!--<form action = "/questionAdmin/update/{{ question.pk }}" method = "post">-->
                                            <form>
                                                {% csrf_token %}
                                                <td><input type="text" style="width: 250px" class="noBorder"
                                                           name="questionText"
                                                           value="{{ question.questionText }}"></input></td>
                                                <td><input type="text" style="width: 200px" class="noBorder"
                                                           name="pubDate" value="{{ question.pubDate }}"></input></td>
                                                <td><input type="text" style="width: 200px" class="noBorder"
                                                           name="QuestionType"
                                                           value="{{ question.QuestionType.name }}"></input></td>
                                                <td><input type="text" style="width: 200px" class="noBorder"
                                                           name="questionGroup"
                                                           value="{{ question.questionGrouping.grouping }}"></input>
                                                </td>
                                                <td>
                                                    <button class='btn btn-success btn-xs' type = "button" onclick = "editQuestion({{ question.pk }})">Edit
                                                    </button>
                                                </td>
                                            </form>
                                            <td>
                                                <form action="/questionAdmin/delete/{{ question.pk }}" method="post"
                                                      onsubmit="return confirmDeletion()">
                                                    {% csrf_token %}
                                                    <button type='submit' name="remove" class='btn btn-warning btn-xs'
                                                            id='remove'>Delete
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}
